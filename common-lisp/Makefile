.PHONY: help init build build-jupyter build-all rebuild rebuild-jupyter rebuild-all
.PHONY: up up-sbcl up-jupyter down down-jupyter down-all stop stop-jupyter restart restart-jupyter
.PHONY: clean clean-volumes logs logs-sbcl logs-jupyter ps status
.PHONY: repl shell notebook run run-example test watch install version env-check info

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
.DEFAULT_GOAL := help

##@ ãƒ˜ãƒ«ãƒ—

help: ## ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
	@echo 'Common Lispé–‹ç™ºç’°å¢ƒ'
	@echo ''
	@echo 'ä½¿ç”¨æ–¹æ³•:'
	@echo '  make <target>'
	@echo ''
	@awk 'BEGIN {FS = ":.*##"; printf "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

init: ## åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆ.envãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼‰
	@if [ ! -f .env ]; then \
		echo ".envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™..."; \
		cp .env.example .env; \
		echo "âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"; \
	else \
		echo "âš ï¸  .envãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"; \
	fi

##@ èµ·å‹•ãƒ»åœæ­¢

up: ## SBCL REPLã‚’èµ·å‹•
	docker compose up -d
	@echo "âœ… SBCL REPLã‚’èµ·å‹•ã—ã¾ã—ãŸ"
	@echo ""
	@echo "æ¥ç¶š: make repl"

up-sbcl: ## SBCL REPLã‚’èµ·å‹•ï¼ˆupã¨åŒã˜ï¼‰
	docker compose up -d
	@echo "âœ… SBCL REPLã‚’èµ·å‹•ã—ã¾ã—ãŸ (make repl ã§æ¥ç¶š)"

up-jupyter: ## Jupyter Notebookã‚’èµ·å‹•
	@docker compose -f docker-compose-jupyter.yml up -d
	@echo ""
	@echo "âœ… Jupyter Notebookã‚’èµ·å‹•ã—ã¾ã—ãŸ"
	@echo ""
	@echo "=========================================="
	@. ./.env 2>/dev/null || true; \
	HOST=$${JUPYTER_HOST:-127.0.0.1}; \
	PORT=$${JUPYTER_PORT:-8888}; \
	TOKEN=$${JUPYTER_TOKEN}; \
	echo "ğŸ“ ã‚¢ã‚¯ã‚»ã‚¹URL:"; \
	if [ -n "$$TOKEN" ]; then \
		echo "   http://localhost:$$PORT/?token=$$TOKEN"; \
	else \
		echo "   http://localhost:$$PORT/"; \
		echo ""; \
		echo "âš ï¸  è­¦å‘Š: ãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ãŒç„¡åŠ¹ã§ã™"; \
		echo "   ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ .env ã§ JUPYTER_TOKEN ã‚’è¨­å®šã—ã¦ãã ã•ã„"; \
	fi; \
	echo ""; \
	echo "ğŸ”‘ ãƒˆãƒ¼ã‚¯ãƒ³: $${TOKEN:-<æœªè¨­å®š>}"; \
	echo "ğŸ–¥ï¸  ãƒã‚¤ãƒ³ãƒ‰: $$HOST (localhostã®ã¿)"; \
	echo "ğŸ”Œ ãƒãƒ¼ãƒˆ: $$PORT"
	@echo "=========================================="
	@echo ""
	@echo "ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã: make notebook"

down: ## SBCL REPLã‚’åœæ­¢ãƒ»å‰Šé™¤
	docker compose down

down-jupyter: ## Jupyter Notebookã‚’åœæ­¢ãƒ»å‰Šé™¤
	docker compose -f docker-compose-jupyter.yml down

down-all: ## ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ãƒ»å‰Šé™¤
	docker compose down
	docker compose -f docker-compose-jupyter.yml down

stop: ## SBCL REPLã‚’åœæ­¢ï¼ˆå‰Šé™¤ã—ãªã„ï¼‰
	docker compose stop

stop-jupyter: ## Jupyter Notebookã‚’åœæ­¢ï¼ˆå‰Šé™¤ã—ãªã„ï¼‰
	docker compose -f docker-compose-jupyter.yml stop

restart: ## SBCL REPLã‚’å†èµ·å‹•
	docker compose restart

restart-jupyter: ## Jupyter Notebookã‚’å†èµ·å‹•
	docker compose -f docker-compose-jupyter.yml restart

##@ ãƒ“ãƒ«ãƒ‰

build: ## SBCL REPLã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
	docker compose build

build-jupyter: ## Jupyter Notebookã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
	docker compose -f docker-compose-jupyter.yml build

build-all: ## ã™ã¹ã¦ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
	docker compose build
	docker compose -f docker-compose-jupyter.yml build

rebuild: ## SBCL REPLã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†ãƒ“ãƒ«ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼‰
	docker compose build --no-cache

rebuild-jupyter: ## Jupyter Notebookã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†ãƒ“ãƒ«ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼‰
	docker compose -f docker-compose-jupyter.yml build --no-cache

rebuild-all: ## ã™ã¹ã¦ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å†ãƒ“ãƒ«ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼‰
	docker compose build --no-cache
	docker compose -f docker-compose-jupyter.yml build --no-cache

##@ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

clean: ## ã™ã¹ã¦å‰Šé™¤ï¼ˆã‚³ãƒ³ãƒ†ãƒŠãƒ»ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ»ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
	@echo "âš ï¸  ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒŠã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™"
	@read -p "ç¶šè¡Œã—ã¾ã™ã‹? [y/N] " confirm && [ "$$confirm" = "y" ] || exit 1
	docker compose down -v --rmi local
	docker compose -f docker-compose-jupyter.yml down -v --rmi local
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

clean-volumes: ## ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ã¿å‰Šé™¤
	docker compose down -v
	docker compose -f docker-compose-jupyter.yml down -v

##@ ãƒ­ã‚°ãƒ»çŠ¶æ…‹ç¢ºèª

logs: ## SBCL REPLã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	docker compose logs -f

logs-sbcl: ## SBCL REPLã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	docker compose logs -f

logs-jupyter: ## Jupyter Notebookã®ãƒ­ã‚°ã‚’è¡¨ç¤º
	docker compose -f docker-compose-jupyter.yml logs -f

ps: ## å®Ÿè¡Œä¸­ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
	@echo "=== SBCL REPL ==="
	@docker compose ps
	@echo ""
	@echo "=== Jupyter Notebook ==="
	@docker compose -f docker-compose-jupyter.yml ps

status: ## ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
	@echo "=== SBCL REPL ==="
	@docker compose ps
	@echo ""
	@echo "=== Jupyter Notebook ==="
	@docker compose -f docker-compose-jupyter.yml ps

##@ æ¥ç¶šãƒ»ã‚¢ã‚¯ã‚»ã‚¹

repl: ## SBCL REPLã«æ¥ç¶š
	docker compose exec sbcl sbcl

shell: ## ã‚³ãƒ³ãƒ†ãƒŠã®ã‚·ã‚§ãƒ«ã«æ¥ç¶š
	docker compose exec sbcl sh

notebook: ## Jupyter Notebookã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
	@echo "Jupyter Notebookã‚’é–‹ãã¾ã™..."
	@. ./.env 2>/dev/null || true; \
	PORT=$${JUPYTER_PORT:-8888}; \
	TOKEN=$${JUPYTER_TOKEN}; \
	if [ -n "$$TOKEN" ]; then \
		URL="http://localhost:$$PORT/?token=$$TOKEN"; \
	else \
		URL="http://localhost:$$PORT/"; \
	fi; \
	echo "URL: $$URL"; \
	sleep 1; \
	open "$$URL" 2>/dev/null || xdg-open "$$URL" 2>/dev/null || echo "ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãã ã•ã„: $$URL"

##@ å®Ÿè¡Œãƒ»ãƒ†ã‚¹ãƒˆ

run: ## Lispãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œï¼ˆusage: make run FILE=src/hello.lispï¼‰
	@if [ -z "$(FILE)" ]; then \
		echo "ã‚¨ãƒ©ãƒ¼: FILEã‚’æŒ‡å®šã—ã¦ãã ã•ã„"; \
		echo "ä¾‹: make run FILE=src/hello.lisp"; \
		exit 1; \
	fi
	docker compose exec sbcl sbcl --load $(FILE) --quit

run-example: ## ã‚µãƒ³ãƒ—ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ
	@echo "=== 01-basics.lisp ==="
	@docker compose exec sbcl sbcl --load src/01-basics.lisp --eval "(run-basics)" --quit
	@echo ""
	@echo "=== 02-lists.lisp ==="
	@docker compose exec sbcl sbcl --load src/02-lists.lisp --eval "(run-lists)" --quit
	@echo ""
	@echo "=== 03-control.lisp ==="
	@docker compose exec sbcl sbcl --load src/03-control.lisp --eval "(run-control)" --quit

test: ## ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
	@echo "ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ..."
	@if [ -d "test" ]; then \
		docker compose exec sbcl sbcl --load test/run-tests.lisp --quit; \
	else \
		echo "âš ï¸  testãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"; \
	fi

##@ é–‹ç™º

watch: ## ãƒ­ã‚°ã‚’ç›£è¦–
	docker compose logs -f

install: ## Quicklispã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆusage: make install PKG=alexandriaï¼‰
	@if [ -z "$(PKG)" ]; then \
		echo "ã‚¨ãƒ©ãƒ¼: PKGã‚’æŒ‡å®šã—ã¦ãã ã•ã„"; \
		echo "ä¾‹: make install PKG=alexandria"; \
		exit 1; \
	fi
	docker compose exec sbcl sbcl --eval "(ql:quickload :$(PKG))" --quit

version: ## SBCLãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¡¨ç¤º
	@docker compose exec sbcl sbcl --version 2>&1 | grep SBCL || echo "ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“"

##@ ãã®ä»–

env-check: ## ç’°å¢ƒè¨­å®šã‚’ç¢ºèª
	@echo "=== ç’°å¢ƒè¨­å®š ==="
	@if [ -f .env ]; then \
		echo "âœ… .env ãƒ•ã‚¡ã‚¤ãƒ«: å­˜åœ¨"; \
		echo ""; \
		cat .env; \
	else \
		echo "âŒ .env ãƒ•ã‚¡ã‚¤ãƒ«: å­˜åœ¨ã—ãªã„"; \
		echo ""; \
		echo "å®Ÿè¡Œ: make init"; \
	fi

info: ## ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’è¡¨ç¤º
	@echo "=== Dockeræƒ…å ± ==="
	@docker --version
	@docker compose version
	@echo ""
	@echo "=== ã‚¤ãƒ¡ãƒ¼ã‚¸ ==="
	@docker images | grep -E "REPOSITORY|common-lisp|clfoundation" || echo "ã‚¤ãƒ¡ãƒ¼ã‚¸ãªã—"
	@echo ""
	@echo "=== ãƒœãƒªãƒ¥ãƒ¼ãƒ  ==="
	@docker volume ls | grep -E "DRIVER|common-lisp" || echo "ãƒœãƒªãƒ¥ãƒ¼ãƒ ãªã—"
